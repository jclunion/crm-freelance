generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// Modèles NextAuth
// ============================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ============================================
// Utilisateur (étendu pour NextAuth)
// ============================================

model User {
  id              String    @id @default(cuid())
  email           String    @unique
  emailVerified   DateTime?
  motDePasse      String?   // Hash bcrypt pour credentials
  nomAffiche      String?
  image           String?
  logoUrl         String?   // Logo affiché sur le portail client
  role            String    @default("freelance_solo") // freelance_solo, membre_agence, admin
  fuseauHoraire   String    @default("Europe/Paris")
  langueInterface String    @default("fr")

  accounts        Account[]
  sessions        Session[]
  clients         Client[]
  opportunites    Opportunite[]
  ticketsAssignes Ticket[]       @relation("TicketAssigne")
  documents       Document[]

  dateCreation    DateTime @default(now())
  dateMiseAJour   DateTime @updatedAt

  @@map("users")
}

// Client (organisation ou personne)
model Client {
  id                 String   @id @default(cuid())
  nom                String
  typeClient         String   // freelance, agence, entreprise, particulier
  emailPrincipal     String?
  telephonePrincipal String?
  statutClient       String   @default("prospect") // prospect, client
  noteInterne        String?

  // Informations entreprise / organisation
  raisonSociale      String?
  siteWeb            String?
  logoClientUrl      String?  // Logo spécifique de l'entreprise cliente (portail + fiche client)
  adresseLigne1      String?
  adresseLigne2      String?
  codePostal         String?
  ville              String?
  pays               String?
  siret              String?
  numeroTva          String?
  secteurActivite    String?
  tailleEntreprise   String?

  proprietaireId     String
  proprietaire       User @relation(fields: [proprietaireId], references: [id])

  contacts           Contact[]
  opportunites       Opportunite[]
  tickets            Ticket[]
  evenements         EvenementTimeline[]

  // Accès portail client (lien partagé)
  tokenPortail       String?

  dateCreation       DateTime @default(now())
  dateMiseAJour      DateTime @updatedAt

  @@map("clients")
}

// Contact chez un client
model Contact {
  id        String  @id @default(cuid())
  clientId  String
  client    Client  @relation(fields: [clientId], references: [id], onDelete: Cascade)

  prenom    String
  nom       String
  email     String
  telephone String?
  role      String?

  @@map("contacts")
}

// Opportunité commerciale
model Opportunite {
  id                   String    @id @default(cuid())
  clientId             String
  client               Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  titre                String
  descriptionCourte    String?
  montantEstime        Float?
  devise               String    @default("EUR")
  probabilite          Int?      // 0-100
  dateCloturePrevue    DateTime?
  etapePipeline        String    @default("lead") // lead, qualifie, proposition_envoyee, negociation, gagne, perdu
  raisonPerdu          String?

  proprietaireId       String
  proprietaire         User @relation(fields: [proprietaireId], references: [id])

  documents            Document[]

  dateCreation         DateTime @default(now())
  dateMiseAJour        DateTime @updatedAt

  // Paiement lié à l'opportunité (MVP simple : un seul paiement Stripe)
  statutPaiement       String   @default("en_attente") // en_attente, paye
  urlPaiement          String?
  stripeSessionId      String?

  @@map("opportunites")
}

// Document lié à une opportunité (contrat, devis, facture, etc.)
model Document {
  id               String   @id @default(cuid())
  opportuniteId    String
  opportunite      Opportunite @relation(fields: [opportuniteId], references: [id], onDelete: Cascade)

  nom              String   // Nom affiché (ex: "Contrat de prestation")
  typeDocument     String   // contrat, devis, facture, autre
  fichierUrl       String   // URL du fichier (stockage externe ou local)
  tailleFichier    Int?     // Taille en octets
  mimeType         String?  // Type MIME (application/pdf, etc.)

  visiblePortail   Boolean  @default(true) // Si le document est visible sur le portail client

  proprietaireId   String
  proprietaire     User @relation(fields: [proprietaireId], references: [id])

  dateCreation     DateTime @default(now())
  dateMiseAJour    DateTime @updatedAt

  @@map("documents")
}

// Ticket de support
model Ticket {
  id             String    @id @default(cuid())
  clientId       String
  client         Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)

  sujet          String
  description    String
  typeTicket     String    // bug, question, demande_evolution
  priorite       String    @default("normale") // basse, normale, haute
  statutTicket   String    @default("nouveau") // nouveau, en_cours, resolu

  assigneId      String?
  assigne        User? @relation("TicketAssigne", fields: [assigneId], references: [id])

  dateCreation   DateTime  @default(now())
  dateMiseAJour  DateTime  @updatedAt
  dateResolution DateTime?

  @@map("tickets")
}

// Événement timeline (pour la vue 360° client)
model EvenementTimeline {
  id               String   @id @default(cuid())
  clientId         String
  client           Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  typeEvenement    String   // opportunite_creee, opportunite_etape_changee, ticket_cree, ticket_statut_change, note_client, email_client, paiement_recu
  referenceId      String?  // id de l'opportunité ou du ticket
  descriptionTexte String

  dateEvenement    DateTime @default(now())
  auteurId         String?

  @@map("evenements_timeline")
}
